# NoStop - 智能骑行路书生成 App (MVP) 产品需求文档 (PRD)

## 1. 项目概述
**项目名称**：NoStop  
**版本**：MVP (Minimum Viable Product)  
**核心目标**：解决城市公路车绕圈训练的刚需场景——红绿灯少、不掉头、节奏不断。  
**核心价值**：可用、可解释、可重复。  
**目标用户**：城市公路车骑行爱好者，注重训练效率，厌恶频繁停车。

## 2. 范围界定 (Scope)

### 2.1 不做清单 (Out of Scope)
为了确保 MVP 在 2-4 个月内落地，以下功能明确**不做**：
*   ❌ **Garmin/码表自动同步**（仅预留接口，支持 GPX 文件导出）
*   ❌ **复杂爬坡建模**（不专门寻找爬坡路线）
*   ❌ **风向/天气集成**
*   ❌ **社交功能**（排行榜、分享动态等）
*   ❌ **AI 自由聊天**（仅限结构化指令解析）

### 2.2 核心功能 (In Scope)
*   **用户输入**：位置、距离、训练类型。
*   **意图解析**：将自然语言转化为结构化约束参数。
*   **路线生成**：基于算法生成多条闭环路线候选。
*   **路线评分**：基于红绿灯、掉头弯、急弯、连续性进行评分筛选。
*   **智能路书**：生成人类可读的路线解释和注意事项。
*   **地图与导出**：可视化展示及 GPX 文件导出。

## 3. 功能架构

### 3.1 逻辑分层
1.  **用户输入层**：当前位置、训练目标（距离、类型）。
2.  **意图解析层 (LLM)**：解析骑行类型、关键约束（如“不掉头”、“少红绿灯”）。
3.  **路线生成层 (算法)**：基于路网生成 N 条候选回环。
4.  **评分筛选层**：计算红绿灯数、掉头弯数、连续性得分，筛选最优路线。
5.  **路书生成层 (LLM)**：生成文字解释、分段说明、注意事项。
6.  **展示导出层**：地图渲染、GPX 导出。

## 4. 详细功能需求

### 4.1 首页 / 生成页
*   **输入项**：
    *   📍 **当前位置**：自动获取，支持微调。
    *   📏 **目标距离**：快捷选项 (10km, 20km, 30km, 40km)。
    *   🎯 **训练类型**：默认选中“绕圈训练”（MVP 核心），预留其他类型入口。
*   **交互要求**：极简设计，减少用户认知负担。

### 4.2 意图解析 (LLM)
*   **输入**：自然语言指令（例如：“我想在家附近绕圈骑 30 公里，别老停”）。
*   **输出**：结构化 JSON 参数。
    *   `mode`: "urban_loop"
    *   `distance_km`: 30
    *   `stop_tolerance`: "very_low"
    *   `u_turn_allowed`: false
    *   `priority`: ["continuity", "safety"]
*   **价值**：兜底非标准输入，提供灵活入口。

### 4.3 路线候选生成 (核心算法)
*   **策略**：从起点向 4-8 个方向发散，尝试构造闭环。
*   **约束**：
    *   距离误差：目标距离 ±10%。
    *   避让：不穿主干高架、不进小区内部路。
*   **数量**：生成 10-20 条初筛候选路线。

### 4.4 路线评分模型
*   **核心指标**：
    *   🚦 **红绿灯数**：路口信号灯数量（权重高）。
    *   ↩️ **掉头弯**：U-turn 数量（权重极高）。
    *   ↪️ **急弯**：< 45° 弯道。
    *   🛣️ **路段连续性**：≥ 500m 直行路段长度。
    *   🔄 **闭合度**：起终点距离。
*   **简化公式**：`Score = -(红绿灯 * 5) - (掉头弯 * 10) - (急弯 * 4) + (连续路段 * 3)`
*   **目标**：筛选出的路线体验需明显优于随机规划。

### 4.5 路书生成
*   **输出内容**：
    *   **摘要**：路线总长、红绿灯数、掉头情况。
    *   **分段详解**：如“第 2–5km 是连续直路，适合做稳定功率输出”。
    *   **警告**：如“夜骑建议注意第 1km 路段照明稍弱”。
*   **格式**：自然语言文本 + 结构化数据（用于地图高亮）。

### 4.6 地图展示 & 导出
*   **地图交互**：
    *   显示路线轨迹。
    *   标注红绿灯、关键转弯点。
*   **导出功能**：
    *   一键生成 `.gpx` 文件。
    *   支持分享到第三方应用（微信/文件管理）。

## 5. 用户流程 (User Flow)
1.  **启动**：打开 App，自动定位。
2.  **设置**：选择「30km」+「绕圈训练」。
3.  **生成**：点击生成，等待约 10 秒（显示处理进度）。
4.  **决策**：查看推荐路线地图和文字路书解释。
5.  **导出**：导出 GPX 文件发送到码表或 Strava。
6.  **反馈**：骑行结束后（可选）反馈路线真实体验。

## 6. 成功标准 (Success Metrics)
*   **体验**：骑行中很少被迫停下来。
*   **留存**：一圈骑完，用户愿意再来一圈（复用率）。
*   **性能**：路线生成耗时 < 15秒。
